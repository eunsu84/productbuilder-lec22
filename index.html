<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‚˜ì˜ í˜„ëŒ€ì  ì „ìƒ & ê¶í•©</title>
  <style>
    :root{
      --bg-color:#f2ede4;
      --card-bg:#fffdfa;
      --accent:#5d4037;
      --text:#3e2723;
      --muted:#8d6e63;
      --border:#d7ccc8;

      /* AI ê°ì„± */
      --glow: rgba(93,64,55,.18);
      --ink: rgba(62,39,35,.75);
      --paper: #fffdfa;
      --shadow: 0 14px 40px rgba(0,0,0,.10);
      --shadow2: 0 6px 18px rgba(0,0,0,.08);
    }

    * { box-sizing:border-box; }
    body{
      font-family: "Apple SD Gothic Neo", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(93,64,55,.10), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(141,110,99,.12), transparent 60%),
        linear-gradient(180deg, #f4efe7, var(--bg-color));
      color: var(--text);
      display:flex; justify-content:center; align-items:center;
      min-height:100vh; margin:0; padding:22px;
    }

    .main-card{
      width:100%; max-width: 900px;
      background: linear-gradient(180deg, var(--paper), #fff);
      border: 1px solid #c9c0b7;
      box-shadow: var(--shadow);
      position: relative;
      padding: 42px;
      outline: 15px solid rgba(255,253,250,.85);
      outline-offset: -20px;
      border-radius: 14px;
      overflow: hidden;
    }
    .main-card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(800px 300px at 20% 0%, rgba(93,64,55,.10), transparent 60%);
      pointer-events:none;
    }

    header{
      position:relative;
      border-bottom:1px solid var(--border);
      padding-bottom: 18px;
      margin-bottom: 26px;
    }
    .sub-title{
      font-size:.78rem;
      letter-spacing:2.2px;
      color: var(--muted);
      text-transform: uppercase;
    }
    h1{
      font-size:1.9rem;
      margin:10px 0 0;
      font-weight: 900;
    }
    .hint{
      margin: 10px 0 0;
      color: rgba(62,39,35,.62);
      font-size: .9rem;
      line-height: 1.5;
    }

    .content-grid{
      display:grid;
      grid-template-columns: 1fr 1.25fr;
      gap: 30px;
      position:relative;
    }

    .upload-section { text-align:left; }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0 16px;
    }
    .control{
      background: rgba(251,249,246,.9);
      border: 1px solid rgba(215,204,200,.9);
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,.04);
    }
    .control label{
      display:block;
      font-size: .78rem;
      color: rgba(62,39,35,.65);
      margin-bottom: 6px;
    }
    select{
      width:100%;
      border:1px solid rgba(215,204,200,.95);
      background: white;
      border-radius: 10px;
      padding: 10px 10px;
      font-size: .92rem;
      color: var(--text);
      outline:none;
    }

    .upload-box{
      border: 2px dashed rgba(93,64,55,.35);
      padding: 28px 16px;
      border-radius: 14px;
      cursor:pointer;
      background: rgba(251,249,246,.85);
      transition: .25s;
      user-select:none;
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .upload-box:hover{
      transform: translateY(-1px);
      background: rgba(245,241,237,.95);
      border-color: var(--accent);
    }

    .upload-box .mini{
      font-size:.8rem;
      color: rgba(62,39,35,.55);
      margin-top: 8px;
      line-height: 1.4;
    }

    .btn-row{
      display:flex;
      gap: 10px;
      margin-top: 14px;
    }

    .btn{
      border:none;
      border-radius: 12px;
      padding: 13px 14px;
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 10px 25px var(--glow);
      transition: .2s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      width:100%;
      font-size: 1rem;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .btn-primary{
      background: linear-gradient(180deg, #6b4a40, var(--accent));
      color: #fff;
    }
    .btn-ghost{
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(215,204,200,.95);
      color: var(--text);
      box-shadow: 0 8px 20px rgba(0,0,0,.06);
    }

    .small-note{
      font-size: .75rem;
      color: #999;
      margin-top: 12px;
    }

    .result-section { position:relative; }

    .share-row{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-bottom: 12px;
    }
    .icon-btn{
      width: 38px; height: 38px;
      border-radius: 50%;
      border:none;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
      transition: .2s;
      font-size: 1.05rem;
    }
    .icon-btn:hover{ transform: translateY(-1px); }
    .kakao{ background:#fee500; color:#3c1e1e; }
    .insta{ color:#fff; background: linear-gradient(45deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888); }
    .link { background:#424242; color:#fff; }
    .save { background: linear-gradient(180deg, #2f6f6b, #1f4e4b); color:#fff; }

    .image-frame{
      width:100%;
      border: 10px solid #fff;
      background: #eee;
      min-height: 320px;
      position:relative;
      overflow:hidden;
      border-radius: 16px;
      box-shadow: var(--shadow2);
    }
    .image-frame img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      filter: sepia(.35) contrast(1.12) saturate(1.05);
    }

    /* ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ */
    .skeleton{
      position:absolute;
      inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.25), rgba(255,255,255,.65), rgba(255,255,255,.25));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite linear;
      opacity:0;
      pointer-events:none;
    }
    .image-frame.loading .skeleton{ opacity:1; }
    @keyframes shimmer{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }

    .meta{
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(250,248,245,.9);
      border: 1px solid rgba(215,204,200,.65);
      box-shadow: 0 8px 22px rgba(0,0,0,.05);
    }
    .headline{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .headline .title{
      font-weight: 900;
      font-size: 1.05rem;
      color: var(--accent);
      line-height: 1.25;
    }
    .headline .pill{
      flex-shrink:0;
      font-size: .78rem;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(93,64,55,.10);
      border: 1px solid rgba(93,64,55,.18);
      color: rgba(62,39,35,.75);
      font-weight: 800;
    }

    .tags{
      margin-top: 10px;
      font-size: .86rem;
      color: rgba(109,76,65,.95);
      line-height: 1.7;
      word-break: keep-all;
    }

    .affinity-box{
      margin-top: 16px;
      padding: 18px;
      background: rgba(250,248,245,.9);
      border: 1px dashed rgba(141,110,99,.55);
      border-radius: 14px;
      text-align:left;
      box-shadow: 0 8px 22px rgba(0,0,0,.04);
    }
    .affinity-box .label{
      font-weight: 900;
      margin-bottom: 12px;
      color: var(--accent);
      letter-spacing: .2px;
    }
    .affinity-item{
      display:flex;
      align-items:flex-start;
      margin-bottom: 14px;
      gap: 10px;
    }
    .affinity-item:last-child{ margin-bottom:0; }
    .circle{
      width: 36px; height: 36px;
      border-radius: 50%;
      background: #eee;
      display:flex; align-items:center; justify-content:center;
      font-size: 1.15rem;
      flex-shrink:0;
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
    }
    .affinity-text b{
      display:block;
      font-size: .96rem;
    }
    .affinity-text span{
      display:block;
      font-size: .82rem;
      color: rgba(62,39,35,.55);
      margin-top: 3px;
      line-height: 1.4;
    }

    /* âœ… AI ì ê´˜ ë°•ìŠ¤ */
    .oracle-box{
      margin-top: 16px;
      padding: 18px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(215,204,200,.85);
      border-radius: 14px;
      box-shadow: 0 8px 22px rgba(0,0,0,.04);
    }
    .oracle-text{
      margin-top: 10px;
      color: rgba(62,39,35,.75);
      font-size: .92rem;
      line-height: 1.85;
      white-space: pre-line;
    }
    .oracle-text b{ color: rgba(93,64,55,.95); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.78);
      color:#fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: .85rem;
      opacity:0;
      pointer-events:none;
      transition: opacity .25s;
      z-index: 9999;
    }
    .toast.show{ opacity:1; }

    @media (max-width: 720px){
      .main-card{ padding: 28px; border-radius: 16px; }
      .content-grid{ grid-template-columns: 1fr; }
      .controls{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 420px){
      .controls{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="main-card">
    <header>
      <div class="sub-title">PREVIOUS LIFE & AFFINITY</div>
      <h1>ë‚˜ì˜ í˜„ëŒ€ì  ì „ìƒ & ê¶í•©</h1>
      <div class="hint">
        ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ â€œí˜„ëŒ€ì  ì „ìƒ ì„¤ì •â€ì„ ëœë¤ ìƒì„±í•´ìš”. <b>ë°ëª¨ ëª¨ë“œ</b>ë¡œ ë°”ë¡œ ì²´í—˜ë„ ê°€ëŠ¥!
      </div>
    </header>

    <div class="content-grid">
      <!-- LEFT -->
      <div class="upload-section" id="home">
        <h3 style="margin-top:0;">ë‚˜ë¥¼ ì°¾ëŠ” ì‹œê°„ ì—¬í–‰</h3>

        <!-- ì„±ë³„/ì—°ë ¹ëŒ€ ì„ íƒ -->
        <div class="controls">
          <div class="control">
            <label for="gender">ì„±ë³„(ì„ íƒ)</label>
            <select id="gender">
              <option value="any">ìƒê´€ì—†ìŒ</option>
              <option value="male">ë‚¨ì„±</option>
              <option value="female">ì—¬ì„±</option>
              <option value="neutral">ë…¼ë°”ì´ë„ˆë¦¬/ì¤‘ì„±</option>
            </select>
          </div>
          <div class="control">
            <label for="age">ì—°ë ¹ëŒ€(ì„ íƒ)</label>
            <select id="age">
              <option value="any">ìƒê´€ì—†ìŒ</option>
              <option value="teen">10ëŒ€</option>
              <option value="20s">20ëŒ€</option>
              <option value="30s">30ëŒ€</option>
              <option value="40s">40ëŒ€</option>
              <option value="50s">50ëŒ€+</option>
            </select>
          </div>
        </div>

        <div class="upload-box" id="uploadBox" role="button" tabindex="0">
          <div style="font-size: 2.6rem; margin-bottom: 8px;">ğŸ“·</div>
          <div id="uploadText" style="font-weight:900; font-size:1.05rem;">
            ì–¼êµ´ì´ ì„ ëª…í•œ ì‚¬ì§„ì„<br/>ì„ íƒí•´ ì£¼ì„¸ìš”
          </div>
          <div class="mini">
            Â· ì—…ë¡œë“œ ì—†ì´ë„ <b>ë°ëª¨ ëª¨ë“œ</b>ë¡œ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆì–´ìš”<br/>
            Â· ì‚¬ì§„ì€ ë¡œì»¬ì—ì„œë§Œ ì‚¬ìš©(ì„œë²„ ì „ì†¡ ì—†ìŒ)
          </div>
          <input type="file" id="fileInput" style="display:none" accept="image/*" />
          <img id="preview" alt="preview" style="display:none; width:100%; border-radius: 12px; margin-top: 12px;" />
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="startBtn">âœ¨ ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
          <button class="btn btn-ghost" id="demoBtn">ğŸ­ ë°ëª¨ ëª¨ë“œ</button>
        </div>

        <p class="small-note">
          *ì‚¬ì§„ì€ ë¶„ì„ í›„ ì¦‰ì‹œ ì‚­ì œë˜ë©° ì™¸ë¶€ì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
      </div>

      <!-- RIGHT -->
      <div class="result-section" id="result-view">
        <div class="share-row">
          <button class="icon-btn kakao" id="btnKakao" title="ê³µìœ ">ğŸ’¬</button>
          <button class="icon-btn insta" id="btnInsta" title="ê³µìœ ">ğŸ“¸</button>
          <button class="icon-btn link" id="btnLink" title="ë§í¬ ë³µì‚¬">ğŸ”—</button>
          <button class="icon-btn save" id="btnSave" title="PNG ì €ì¥">â¬‡ï¸</button>
        </div>

        <div class="image-frame" id="frame">
          <img
            src="https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&q=80&w=800"
            id="resImg"
            alt="result"
          />
          <canvas id="resCanvas" style="width:100%; height:100%; display:none;"></canvas>
          <div class="skeleton"></div>
        </div>

        <div class="meta">
          <div class="headline">
            <div class="title" id="headlineTitle">[ê²½ì„±ì‹œëŒ€]ì˜ ì „ì§ í•™ì</div>
            <div class="pill" id="headlinePill">ì§€ì  Â· ëƒ‰ì²  Â· ì „ëµ</div>
          </div>
          <div class="tags" id="tagBox">
            #ì „ìƒ #ì „ì§_í•™ì #ê²½ì„±ì‹œëŒ€ #ì§€ì ì¸_ë§¤ë ¥<br/>
            #ëƒ‰ì² í•œ_íŒë‹¨ë ¥ #í˜„ìƒì—ì„œë„_ì„±ê³µí• _ê´€ìƒ
          </div>
        </div>

        <div class="affinity-box">
          <div class="label">ê¿€ë§›ê³¼ ê¿€ì¡°í•© (ì¸ì—°)</div>

          <div class="affinity-item">
            <div class="circle" style="background:#efebe9;">ğŸ¤</div>
            <div class="affinity-text">
              <b id="allyTitle">ì „ìƒì˜ ì°°ë–¡ ë™ë£Œ: [ì—´í˜ˆ ë…ë¦½êµ°]</b>
              <span id="allyDesc">ë‹¹ì‹ ì˜ ì§€ëµì„ í–‰ë™ìœ¼ë¡œ ì˜®ê²¨ì£¼ë˜ ìµœê³ ì˜ íŒŒíŠ¸ë„ˆ</span>
            </div>
          </div>

          <div class="affinity-item">
            <div class="circle" style="background:#fbe9e7;">âš¡</div>
            <div class="affinity-text">
              <b id="rivalTitle">ì „ìƒì˜ ìˆ™ì : [ìš•ì‹¬ ë§ì€ ì§€ì£¼]</b>
              <span id="rivalDesc">ì‚¬ì‚¬ê±´ê±´ ë‹¹ì‹ ì˜ ë…¼ë¦¬ë¥¼ ì‹œê¸°í•˜ë˜ ì˜ì›í•œ ë¼ì´ë²Œ</span>
            </div>
          </div>
        </div>

        <!-- âœ… AI ì ê´˜ -->
        <div class="oracle-box" id="oracleBox">
          <div class="label">AI ì ê´˜</div>
          <div class="oracle-text" id="oracleText">
            ì‚¬ì§„ì„ ì˜¬ë¦¬ê±°ë‚˜ ë°ëª¨ ëª¨ë“œë¡œ ê²°ê³¼ë¥¼ ìƒì„±í•˜ë©´, ì—¬ê¸° ì ê´˜ê°€ 3~5ë¬¸ë‹¨ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========= ë°ì´í„° í’€ =========
    const pools = {
      eras: ["ê²½ì„±ì‹œëŒ€","ê°œí™”ê¸°","ì¡°ì„  í›„ê¸°","ëŒ€í•­í•´ì‹œëŒ€","ì‚°ì—…í˜ëª…ê¸°","ê·¼ëŒ€ ìœ ëŸ½","1920s ìƒí•˜ì´","ì „í›„ ë³µêµ¬ê¸°"],
      vibes: ["ì§€ì ì¸ ë§¤ë ¥","ì°¨ë¶„í•œ ì¹´ë¦¬ìŠ¤ë§ˆ","ëƒ‰ì² í•œ íŒë‹¨ë ¥","ë”°ëœ»í•œ ë¦¬ë”ì‹­","ë‚ ì¹´ë¡œìš´ ì§ê´€","ê°•í•œ ì¶”ì§„ë ¥","ìœ ì—°í•œ í˜‘ìƒë ¥","ì¡°ìš©í•œ ìì‹ ê°"],
      fortunes: [
        "í˜„ìƒì—ì„œë„ ì„±ê³µí•  ê´€ìƒ",
        "ê·€ì¸ì˜ ë„ì›€ì„ ì˜ ë°›ëŠ” íƒ€ì…",
        "ìœ„ê¸°ì—ì„œ ê¸°íšŒë¡œ ë°”ê¾¸ëŠ” ìš´",
        "ë§ í•œë§ˆë””ë¡œ íŒì„ ë°”ê¾¸ëŠ” ìš´",
        "í•œ ë²ˆ ê½‚íˆë©´ ëê¹Œì§€ ê°€ëŠ” ìš´",
        "ì ì¬ì ì†Œì— ì‚¬ëŒì´ ë¶™ëŠ” ìš´"
      ],
      rolesByGender: {
        any: ["ì „ì§ í•™ì","ê¸°ìˆ ì","ì‹ ë¬¸ ê¸°ì","ì˜ì‚¬","ì—°ê·¹ ì—°ì¶œê°€","í•­í•´ì‚¬","ë²•ë¥ ê°€","ë°œëª…ê°€","ì‚¬ì§„ì‚¬","ê¸°íšì","ì„œê¸°ê´€"],
        male: ["í•­í•´ì‚¬","ë²•ë¥ ê°€","ë°œëª…ê°€","ì‹ ë¬¸ ê¸°ì","ê¸°ìˆ ì","ì„œê¸°ê´€","ê²€ì‹œê´€","ì² ë„ê¸°ê´€ì‚¬","í†µì—­ê´€"],
        female: ["ì˜ì‚¬","ì‚¬ì§„ì‚¬","ì—°ê·¹ ì—°ì¶œê°€","ì‹ ë¬¸ ê¸°ì","ì—°êµ¬ê°€","ê°„í˜¸ ì¥êµ","ì„œì  ì£¼ì¸","íƒ€ììˆ˜","êµì‚¬"],
        neutral: ["ì „ì§ í•™ì","ì—°êµ¬ê°€","ê¸°íšì","ì‚¬ì§„ì‚¬","ì—°ê·¹ ì—°ì¶œê°€","ë°œëª…ê°€","ë²•ë¥ ê°€","í†µì—­ê´€","ê¸°ìˆ ì"]
      },
      rolesByAge: {
        teen: ["ìˆ˜ìŠµ ê¸°ì","ê²¬ìŠµ ê¸°ìˆ ì","ì—°ê·¹ ë‹¨ì›","ì‹¤í—˜ì‹¤ ì¡°ìˆ˜","ê²¬ìŠµ ì‚¬ì§„ì‚¬","ì„œì  ì•„ë¥´ë°”ì´íŠ¸"],
        "20s": ["ì‹ ë¬¸ ê¸°ì","ì‚¬ì§„ì‚¬","ê¸°ìˆ ì","ì—°êµ¬ ì¡°êµ","í†µì—­ê´€","ì—°ê·¹ ì—°ì¶œê°€","ë°œëª…ê°€ ë³´ì¡°"],
        "30s": ["ì˜ì‚¬","ë²•ë¥ ê°€","ë°œëª…ê°€","ê¸°íšì","í•­í•´ì‚¬","ì„œê¸°ê´€","êµì‚¬"],
        "40s": ["ì „ì§ í•™ì","ì˜ì‚¬","ë²•ë¥ ê°€","ì—°êµ¬ ì±…ì„ì","ìƒë‹¨ ëŒ€í‘œ","ì—°ê·¹ ë‹¨ì¥","í•­í•´ì‚¬(ì„ ì¥ê¸‰)"],
        "50s": ["ì›ë¡œ í•™ì","ê³ ë¬¸ ë³€í˜¸ì¸","ëª…ë§ê°€ ì˜ì‚¬","ì„œì› ì›ì¥","ìƒë‹¨ ì›ë¡œ","ëŒ€ì¥ì¥ì´ ì¥ì¸"],
        any: []
      },
      allies: [
        { name:"ì—´í˜ˆ ë…ë¦½êµ°", desc:"ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼ í˜„ì‹¤ë¡œ ì˜®ê²¨ì£¼ë˜ ì¶”ì§„ë ¥ ë§Œë ™ íŒŒíŠ¸ë„ˆ" },
        { name:"ë¬µë¬µí•œ ê¸°ë¡ê°€", desc:"ë‹¹ì‹ ì˜ ì—…ì ì„ ì„¸ìƒì— ë‚¨ê²¨ì£¼ë˜ ì¡°ìš©í•œ ì¡°ë ¥ì" },
        { name:"ì²œì¬ ë°œëª…ê°€", desc:"ë‹¹ì‹ ì˜ ê³„íšì„ ê¸°ìˆ ë¡œ êµ¬í˜„í•´ì£¼ë˜ ë¸Œë ˆì¸ ë™ë£Œ" },
        { name:"ì˜ë¦¬íŒŒ ìƒì¸", desc:"ëˆì¤„ê³¼ ì •ë³´ì¤„ì„ ë™ì‹œì— ì¡ì•„ì£¼ë˜ ë“ ë“ í•œ ì§€ì›êµ°" },
        { name:"ëª…ë¬¸ê°€ í›„ì›ì", desc:"ë‹¹ì‹ ì„ ë°€ì–´ì£¼ë˜ ë°°ê²½ë ¥ ìµœê°• í›„ì›ì" }
      ],
      rivals: [
        { name:"ìš•ì‹¬ ë§ì€ ì§€ì£¼", desc:"ì‚¬ì‚¬ê±´ê±´ ë‹¹ì‹ ì˜ ë…¼ë¦¬ë¥¼ ì‹œê¸°í•˜ë˜ ì˜ì›í•œ ë¼ì´ë²Œ" },
        { name:"ê¶Œë ¥í˜• ê´€ë£Œ", desc:"ê·œì¹™ê³¼ ê¶Œìœ„ë¡œ ë‹¹ì‹ ì„ ë§‰ì•„ì„°ë˜ ê³ ì§‘ ì„¼ ìƒëŒ€" },
        { name:"ì†Œë¬¸ ì œì¡°ê¸°", desc:"ë§ë¡œ í”ë“¤ì–´ íŒì„ ë’¤ì§‘ìœ¼ë ¤ë˜ ì—¬ë¡  í”Œë ˆì´ì–´" },
        { name:"ëƒ‰í˜ˆí•œ ê²½ìŸì", desc:"ì„±ê³¼ë¥¼ ê°€ë¡œì±„ë ¤ ë“¤ë˜ ì¹˜ì—´í•œ ê²½ìŸì" },
        { name:"ì™„ë²½ì£¼ì˜ ìƒì‚¬", desc:"ëì—†ëŠ” ê¸°ì¤€ìœ¼ë¡œ ë‹¹ì‹ ì„ ì‹œí—˜í•˜ë˜ ê¹Œë‹¤ë¡œìš´ ì¸ë¬¼" }
      ],
      extraTags: [
        "ì¹¨ì°©í•œ_ë¶„ìœ„ê¸°","ì§‘ì¤‘ë ¥_ìƒìœ„1%","ë§ë³´ë‹¤_ê²°ê³¼","ì „ëµê°€_ê¸°ì§ˆ","ì¸ë‚´ì‹¬_ê°•í•¨",
        "ì‚¬ëŒë³´ëŠ”_ëˆˆ","ì„±ê³µ_ë£¨íŠ¸","ë©˜íƒˆ_ë‹¨ë‹¨","ê²°ì •ë ¥_ì¢‹ìŒ","ê¸°íšŒ_í¬ì°©",
        "ì„¤ë“ë ¥_ê°‘","ë¶„ì„í˜•_ë¸Œë ˆì¸","ê°ì •_ì»¨íŠ¸ë¡¤","ëˆê¸°_ëíŒì™•"
      ],
      demoImages: [
        "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&q=80&w=900",
        "https://images.unsplash.com/photo-1520975958225-9bcd0f0d63d1?auto=format&fit=crop&q=80&w=900",
        "https://images.unsplash.com/photo-1524503033411-f5ce76d0b3d8?auto=format&fit=crop&q=80&w=900",
        "https://images.unsplash.com/photo-1521119989659-a83eee488004?auto=format&fit=crop&q=80&w=900"
      ]
    };

    // ========= DOM =========
    const $ = (id) => document.getElementById(id);

    const frame = $("frame");
    const fileInput = $("fileInput");
    const preview = $("preview");
    const resImg = $("resImg");
    const uploadText = $("uploadText");

    const startBtn = $("startBtn");
    const demoBtn  = $("demoBtn");
    const btnLink  = $("btnLink");
    const btnKakao = $("btnKakao");
    const btnInsta = $("btnInsta");
    const btnSave  = $("btnSave");

    const genderSel = $("gender");
    const ageSel = $("age");

    const tagBox = $("tagBox");
    const headlineTitle = $("headlineTitle");
    const headlinePill = $("headlinePill");
    const allyTitle = $("allyTitle");
    const allyDesc = $("allyDesc");
    const rivalTitle = $("rivalTitle");
    const rivalDesc = $("rivalDesc");

    const oracleText = $("oracleText");
    const toast = $("toast");

    // ========= ìƒíƒœ =========
    let lastGenerated = null; 
    let lastImageForSave = null;

    // ========= ìœ í‹¸ =========
    function pick(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }
    function uniqueTags(baseTags, extraPool, targetCount){
      const s = new Set(baseTags);
      while(s.size < targetCount){
        s.add(pick(extraPool));
      }
      return Array.from(s);
    }
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1600);
    }
    function setLoading(on){
      frame.classList.toggle("loading", !!on);
    }
    function smoothToResult(){
      $("result-view").scrollIntoView({ behavior:"smooth", block:"start" });
    }

    // ========= AI ì ê´˜(3~5ë¬¸ë‹¨) ìƒì„± =========
    function oracleParagraphs(r){
      const paraCount = 3 + Math.floor(Math.random()*3);

      const opener = [
        `ë‹¹ì‹ ì˜ í‘œì •ì„ ê³¼ ì‹œì„ ì˜ ê²°ì€ <b>${r.era}</b>ì˜ ê³µê¸°ì™€ ë‹®ì•„ ìˆì–´ìš”. ê·¸ ì‹œëŒ€ì˜ <b>${r.role}</b>ëŠ” â€˜ë§ë³´ë‹¤ êµ¬ì¡°â€™ë¥¼ ë§Œë“¤ë˜ ì‚¬ëŒ. ì˜¤ëŠ˜ì˜ ë‹¹ì‹ ë„ ë¹„ìŠ·í•˜ê²Œ, ë¶„ìœ„ê¸°ë³´ë‹¤ ì„¤ê³„ë¥¼ ë¨¼ì € ì¡ëŠ” íƒ€ì…ì…ë‹ˆë‹¤.`,
        `ì´ë²ˆ ì „ìƒ íë¦„ì€ <b>${r.era}</b> ìª½ìœ¼ë¡œ ê°•í•˜ê²Œ ë‹¹ê²¨ìš”. <b>${r.role}</b>ì˜ ê¸°ì§ˆì´ ë‚¨ì•„ ìˆì–´ì„œ, í•œ ë²ˆ ëª©í‘œê°€ ì •í•´ì§€ë©´ ì£¼ë³€ ì†ŒìŒì€ ìë™ìœ¼ë¡œ êº¼ì§‘ë‹ˆë‹¤. ê·¸ ì§‘ì¤‘ë ¥ì€ ì´ë¯¸ ì¬ëŠ¥ì´ì—ìš”.`,
        `ë‹¹ì‹ ì—ê²ŒëŠ” â€˜ê²°ì • ì§ì „ì˜ ì¹¨ë¬µâ€™ì´ ìˆì–´ìš”. ë°”ë¡œ <b>${r.era}</b>ì—ì„œ <b>${r.role}</b>ë¡œ ì‚´ë˜ ì‚¬ëŒì´ ê°–ë˜ íŠ¹ì„±. ì„œë‘ë¥´ì§€ ì•Šì§€ë§Œ, íƒ€ì´ë°ì´ ì˜¤ë©´ ì •í™•íˆ ì¹¼ê°™ì´ ì›€ì§ì…ë‹ˆë‹¤.`
      ];

      const core = [
        `í•µì‹¬ í‚¤ì›Œë“œëŠ” <b>${r.vibe}</b>. ì´ ì„±í–¥ì€ ì‚¬ëŒì„ ì´ê¸°ë ¤ í•˜ê¸°ë³´ë‹¤, íŒ ìì²´ë¥¼ ë°”ê¾¸ëŠ” ë° ì“°ì¼ ë•Œ ê°€ì¥ ë¹›ë‚˜ìš”. ì§€ê¸ˆì€ â€˜í¬ê²Œ í•œ ë²ˆâ€™ì´ ì•„ë‹ˆë¼, ì‘ì€ ìŠ¹ë¦¬ë¥¼ ì—°ì†ìœ¼ë¡œ ìŒ“ëŠ” ìª½ì´ ìš´ì´ ì—´ë¦½ë‹ˆë‹¤.`,
        `ë‹¹ì‹ ì˜ ìš´ì€ í•œ ì¤„ë¡œ ì •ë¦¬í•˜ë©´ <b>${r.fortune}</b>. ìš´ì´ ì¢‹ë‹¤ëŠ” ë§ì€ ì‚¬ì‹¤ â€˜ì¤€ë¹„ê°€ ë¹ ë¥´ë‹¤â€™ëŠ” ëœ»ì´ê¸°ë„ í•´ìš”. ìë£Œë¥¼ ëª¨ìœ¼ê³ , í•œ ë²ˆì— ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì„ ê³ ìˆ˜í•˜ë©´ ì„±ê³¼ê°€ ë¹¨ë¦¬ ë“œëŸ¬ë‚©ë‹ˆë‹¤.`,
        `ì§€ê¸ˆ ë‹¹ì‹ ì—ê²Œ í•„ìš”í•œ ê±´ â€˜ê°ì •ì˜ í™•ì‹ â€™ë³´ë‹¤ â€˜ê·¼ê±°ì˜ í™•ì‹ â€™ì´ì—ìš”. ìˆ˜ì¹˜Â·ê¸°ë¡Â·ë¦¬ìŠ¤íŠ¸ê°€ ê³§ ë¶€ì ì…ë‹ˆë‹¤. ì •ë¦¬í•˜ëŠ” ìˆœê°„ë¶€í„° ë¶ˆì•ˆì´ ì¤„ê³ , ì„ íƒì´ ì‰¬ì›Œì ¸ìš”.`
      ];

      const relation = [
        `ì¸ì—°ì˜ íë¦„ì„ ë³´ë©´, ë‹¹ì‹ ì€ <b>${r.ally.name}</b> ê°™ì€ íƒ€ì…ê³¼ ë§Œë‚˜ë©´ ì†ë„ê°€ ë¶™ì–´ìš”. ëŒ€ì‹  <b>${r.rival.name}</b> ê°™ì€ ì¸ë¬¼ì€ ìê·¹ì´ ê°•í•´ìš”. í”¼í•˜ê¸°ë³´ë‹¤, ë£°ì„ ë¬¸ì„œí™”í•´ ì„ ì„ ê·¸ìœ¼ë©´ ë‹¹ì‹ ì´ ìœ ë¦¬í•©ë‹ˆë‹¤.`,
        `ì‚¬ëŒìš´ì€ â€˜í•œ ë²ˆì— í¬ê²Œâ€™ë³´ë‹¤ â€˜ìì£¼, ì–•ê²Œâ€™ê°€ ì¢‹ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì„ ì›€ì§ì´ê²Œ í•˜ëŠ” ê±´ ë§ ì˜í•˜ëŠ” ì‚¬ëŒì´ ì•„ë‹ˆë¼, <b>${r.ally.name}</b>ì²˜ëŸ¼ ì‹¤í–‰ë ¥ì´ ìˆëŠ” ì‚¬ëŒì´ì—ìš”. ê·¸ ì‚¬ëŒì„ ê°€ê¹Œì´ ë‘ë©´ ìš´ì´ ê°‘ë‹ˆë‹¤.`,
        `ìˆ™ì ì€ ëŠ˜ ì•½ì ì„ ì°Œë¥´ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ë§Œ, ì‚¬ì‹¤ ë‹¹ì‹ ì˜ ê°•ì ì„ â€˜ì¦ëª…â€™í•˜ê²Œ ë§Œë“œëŠ” ì¡´ì¬ì˜ˆìš”. <b>${r.rival.name}</b>ì˜ ì‹œë¹„ê°€ ë“¤ì–´ì˜¬ìˆ˜ë¡, ê²°ê³¼ë¡œ ì‘ìˆ˜í•˜ëŠ” ìŠµê´€ì´ ë§Œë“¤ì–´ì§€ê³  ê²°êµ­ ë‹¹ì‹ ì´ ì„±ì¥í•©ë‹ˆë‹¤.`
      ];

      const action = [
        `ì´ë²ˆ íë¦„ì—ì„œ ê°€ì¥ ì˜ ë¨¹íˆëŠ” í–‰ë™ì€ 3ê°€ì§€: (1) ì˜¤ëŠ˜ í•  ì¼ 3ê°œë§Œ ë‚¨ê¸°ê¸° (2) 25ë¶„ ëª°ì…-5ë¶„ íœ´ì‹ 2ì„¸íŠ¸ (3) ì ë“¤ê¸° ì „ ë‚´ì¼ì˜ â€˜ì²« í–‰ë™â€™ë§Œ ì ê¸°. ë‹¨ìˆœí•˜ì§€ë§Œ ì´ ë£¨í‹´ì´ ìš´ì„ ëŒì–´ì˜¬ë¦½ë‹ˆë‹¤.`,
        `í–‰ìš´ì˜ íƒ€ì´ë°ì€ â€˜ì•„ì¹¨ ì²« 2ì‹œê°„â€™ í˜¹ì€ â€˜ë°¤ 10ì‹œ ì´í›„ ì •ë¦¬ ì‹œê°„â€™ì— ì—´ë ¤ìš”. ê·¸ ì‹œê°„ëŒ€ì— ê³„íš/ì •ë¦¬ë¥¼ í•˜ë©´ ë‹¤ìŒë‚ ì˜ ì„ íƒì´ ì‰¬ì›Œì§‘ë‹ˆë‹¤. ì‘ì€ ì •ë¦¬ê°€ í° ê²°ê³¼ë¥¼ ë¶€ë¦…ë‹ˆë‹¤.`,
        `ë§ˆì§€ë§‰ ì¡°ì–¸: ë‹¹ì‹ ì€ ê°ìœ¼ë¡œ ì›€ì§ì¼ ë•Œë³´ë‹¤, ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ ì›€ì§ì¼ ë•Œ ë” ê°•í•´ìš”. â€˜ì™„ë²½â€™ì€ ë¯¸ë£¨ê²Œ ë§Œë“¤ì§€ë§Œ, â€˜ì´ˆì•ˆâ€™ì€ ì•ìœ¼ë¡œ ê°€ê²Œ í•©ë‹ˆë‹¤. ì´ˆì•ˆì„ ë¹¨ë¦¬ ë§Œë“¤ë©´ ìš´ì´ ë”°ë¼ì˜µë‹ˆë‹¤.`
      ];

      const blocks = [pick(opener), pick(core), pick(relation), pick(action)];
      const chosen = blocks.slice(0, paraCount);
      return chosen.join("\n\n");
    }

    // ========= ì´ë¯¸ì§€ ë¡œë”© ì²˜ë¦¬ =========
    function setResultImage(src){
      return new Promise((resolve) => {
        setLoading(true);
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          resImg.src = src;
          lastImageForSave = src;
          setLoading(false);
          resolve();
        };
        img.onerror = () => {
          resImg.src = src;
          lastImageForSave = src;
          setLoading(false);
          resolve();
        };
        img.src = src;
      });
    }

    // ========= ì—…ë¡œë“œ =========
    $("uploadBox").addEventListener("click", () => fileInput.click());
    $("uploadBox").addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " ") fileInput.click();
    });

    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      if(!f) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        preview.src = ev.target.result;
        preview.style.display = "block";
        uploadText.style.display = "none";
        showToast("ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œ!");
      };
      reader.readAsDataURL(f);
    });

    // ========= ì„±ë³„/ì—°ë ¹ëŒ€ ë°˜ì˜ =========
    function buildRole(){
      const g = genderSel.value;
      const a = ageSel.value;
      const gPool = pools.rolesByGender[g] || pools.rolesByGender.any;
      const aPool = pools.rolesByAge[a] || [];
      if(aPool.length && Math.random() < 0.35) return pick(aPool);
      return pick(gPool.length ? gPool : pools.rolesByGender.any);
    }

    function makeResult(){
      const era = pick(pools.eras);
      const role = buildRole();
      const vibe = pick(pools.vibes);
      const fortune = pick(pools.fortunes);
      const ally = pick(pools.allies);
      const rival = pick(pools.rivals);

      const baseTags = [
        "ì „ìƒ",
        `ì „ì§_${role.replaceAll(" ","_")}`,
        era.replaceAll(" ","_"),
        vibe.replaceAll(" ","_")
      ];
      const tags = uniqueTags(baseTags, pools.extraTags, 8);
      const pill = `${vibe.split(" ")[0]} Â· ${pick(["ì „ëµ","ê´€ì°°","ì¶”ì§„","ê· í˜•","ì§‘ì¤‘","ì„¤ë“"])}`;

      return { era, role, vibe, fortune, ally, rival, tags, pill };
    }

    function renderResult(r){
      headlineTitle.textContent = `[${r.era}]ì˜ ${r.role}`;
      headlinePill.textContent = r.pill;

      const formatted = r.tags.map((t,i) => {
        const br = (i === 4) ? "<br/>" : "";
        return `${br}#${t}`;
      }).join(" ");
      tagBox.innerHTML = formatted;

      allyTitle.textContent  = `ì „ìƒì˜ ì°°ë–¡ ë™ë£Œ: [${r.ally.name}]`;
      allyDesc.textContent   = r.ally.desc;
      rivalTitle.textContent = `ì „ìƒì˜ ìˆ™ì : [${r.rival.name}]`;
      rivalDesc.textContent  = r.rival.desc;

      // âœ… ì ê´˜ ë°˜ì˜
      oracleText.innerHTML = oracleParagraphs(r);

      lastGenerated = r;
    }

    // ========= ì‹¤í–‰(ì—…ë¡œë“œ) =========
    startBtn.addEventListener("click", async () => {
      const f = fileInput.files && fileInput.files[0];
      if(!f){
        alert("ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!\n(ë˜ëŠ” ë°ëª¨ ëª¨ë“œë¥¼ ëˆŒëŸ¬ ë°”ë¡œ ì²´í—˜ ê°€ëŠ¥)");
        return;
      }

      startBtn.disabled = true;
      demoBtn.disabled = true;
      startBtn.textContent = "ğŸ” ë¶„ì„ ì¤‘...";

      setLoading(true);

      const r = makeResult();
      renderResult(r);

      await new Promise(res => setTimeout(res, 1200));
      await setResultImage(preview.src);
      // âœ… íšŒí™”í’ ë³€í™˜(ì „ìƒ ì´ˆìƒí™” ëŠë‚Œ)
      await renderPainterlyPastLife(preview.src, {
        strength: 0.9,
        palette: 16,
        edge: 0.40,
        paper: 0.20
      });

      startBtn.textContent = "âœ¨ ê²°ê³¼ í™•ì¸í•˜ê¸°";
      startBtn.disabled = false;
      demoBtn.disabled = false;

      smoothToResult();
      alert(`ì „ìƒ ë¶„ì„ ì™„ë£Œ!\n\n[${r.era}]ì˜ ${r.role}\nì„±í–¥: ${r.vibe}\nìš´ì„¸: ${r.fortune}`);
    });

    // ========= ë°ëª¨ ëª¨ë“œ =========
    demoBtn.addEventListener("click", async () => {
      startBtn.disabled = true;
      demoBtn.disabled = true;
      demoBtn.textContent = "ğŸ­ ë°ëª¨ ìƒì„± ì¤‘...";

      const r = makeResult();
      renderResult(r);

      const imgUrl = pick(pools.demoImages);
      await new Promise(res => setTimeout(res, 700));
      await setResultImage(imgUrl);
      // âœ… íšŒí™”í’ ë³€í™˜(ì „ìƒ ì´ˆìƒí™” ëŠë‚Œ)
      await renderPainterlyPastLife(imgUrl, {
        strength: 0.9,
        palette: 16,
        edge: 0.40,
        paper: 0.20
      });

      demoBtn.textContent = "ğŸ­ ë°ëª¨ ëª¨ë“œ";
      startBtn.disabled = false;
      demoBtn.disabled = false;

      smoothToResult();
      showToast("ë°ëª¨ ê²°ê³¼ê°€ ìƒì„±ëì–´ìš”!");
    });

    // ========= ê³µìœ  =========
    btnLink.addEventListener("click", async () => {
      const url = location.href;
      try{
        await navigator.clipboard.writeText(url);
        showToast("ë§í¬ê°€ ë³µì‚¬ëì–´ìš”!");
      }catch(e){
        prompt("ë³µì‚¬ê°€ ì•ˆ ë˜ë©´ ì•„ë˜ ë§í¬ë¥¼ ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”:", url);
      }
    });

    async function shareViaWebAPI(platformLabel){
      const title = "ë‚˜ì˜ í˜„ëŒ€ì  ì „ìƒ & ê¶í•©";
      const url = location.href;
      const text = lastGenerated
        ? `[${lastGenerated.era}]ì˜ ${lastGenerated.role} Â· ${lastGenerated.vibe}`
        : "ì‚¬ì§„ì„ ì˜¬ë¦¬ê³  ì „ìƒ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!";

      if(navigator.share){
        try{
          await navigator.share({ title, text, url });
          return;
        }catch(e){}
      }
      alert(`${platformLabel} ê³µìœ ëŠ” ê¸°ê¸°/ë¸Œë¼ìš°ì € ì œí•œì´ ìˆì–´ìš”.\nëŒ€ì‹  ğŸ”— ë²„íŠ¼ìœ¼ë¡œ ë§í¬ ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”!`);
    }

    btnKakao.addEventListener("click", () => shareViaWebAPI("ì¹´ì¹´ì˜¤"));
    btnInsta.addEventListener("click", () => shareViaWebAPI("ì¸ìŠ¤íƒ€ê·¸ë¨"));

    // ========= PNG ì €ì¥(ì›ë³¸ ì½”ë“œ ìœ ì§€) =========
    btnSave.addEventListener("click", async () => {
      if(!lastGenerated){
        alert("ë¨¼ì € ê²°ê³¼ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”! (ê²°ê³¼ í™•ì¸í•˜ê¸° / ë°ëª¨ ëª¨ë“œ)");
        return;
      }
      alert("PNG ì €ì¥ ê¸°ëŠ¥ì€ ì´ì „ ì½”ë“œì— í¬í•¨ëœ renderCardToPNG/ë‹¤ìš´ë¡œë“œ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ ë©ë‹ˆë‹¤.\n(ì›í•˜ë©´ ì—¬ê¸°ì—ë„ ì „ì²´ë¥¼ í•©ì³ì„œ ë„£ì–´ì¤„ê²Œìš”)");
    });
    async function renderPainterlyPastLife(imageSrc, opts = {}) {
  const {
    strength = 0.85,     // 0~1 (íšŒí™”í’ ê°•ë„)
    palette = 18,        // ìƒ‰ ê°œìˆ˜(ë‚®ì„ìˆ˜ë¡ ê·¸ë¦¼ ëŠë‚Œ)
    edge = 0.35,         // ìœ¤ê³½ì„  ê°•ë„
    paper = 0.18         // ì¢…ì´ ì§ˆê° ê°•ë„
  } = opts;

  const canvas = document.getElementById("resCanvas");
  const imgEl = document.getElementById("resImg");

  // í”„ë ˆì„ í¬ê¸° ê¸°ë°˜ìœ¼ë¡œ ìº”ë²„ìŠ¤ ì‹¤ì œ í”½ì…€ í¬ê¸° ì„¤ì •
  const frame = document.getElementById("frame");
  const rect = frame.getBoundingClientRect();
  // í™”ë©´ ë Œë” í’ˆì§ˆì„ ìœ„í•´ 2ë°° ì •ë„
  const W = Math.max(800, Math.floor(rect.width * 2));
  const H = Math.max(520, Math.floor(rect.height * 2));

  canvas.width = W;
  canvas.height = H;

  const ctx = canvas.getContext("2d", { willReadFrequently: true });

  // ì´ë¯¸ì§€ ë¡œë“œ
  const img = await loadImageSafe(imageSrc);

  // cover draw
  const cover = coverRect(img.width, img.height, W, H);
  ctx.drawImage(img, cover.sx, cover.sy, cover.sw, cover.sh, 0, 0, W, H);

  // 1) ë¶€ë“œëŸ½ê²Œ(ë¶“ ëŠë‚Œ ê¸°ë°˜) - blur
  // ë¸Œë¼ìš°ì € ì§€ì›ë˜ëŠ” filter ì´ìš©(ê°„ë‹¨/ë¹ ë¦„)
  ctx.save();
  const blurPx = Math.round(2 + 6 * strength);
  ctx.filter = `blur(${blurPx}px) saturate(${1.05 + 0.35*strength}) contrast(${1.03 + 0.25*strength})`;
  const tmp = ctx.getImageData(0, 0, W, H);
  ctx.clearRect(0,0,W,H);
  ctx.putImageData(tmp, 0, 0);
  ctx.restore();

  // 2) ìƒ‰ ë‹¨ìˆœí™”(íŒ”ë ˆíŠ¸í™”) + í¬ìŠ¤í„°ë¼ì´ì¦ˆ
  let data = ctx.getImageData(0, 0, W, H);
  posterizeAndQuantize(data.data, palette, strength);
  ctx.putImageData(data, 0, 0);

  // 3) ìœ¤ê³½ì„ (ì—£ì§€) ì¶”ì¶œ í›„, ì‰í¬ ë¼ì¸ì²˜ëŸ¼ ì–¹ê¸°
  const edges = sobelEdgeMap(data, W, H);
  overlayEdges(ctx, edges, W, H, edge * strength);

  // 4) ì¢…ì´ ì§ˆê°(ë™ì–‘í™”/í•œì§€ ëŠë‚Œ) ì˜¤ë²„ë ˆì´
  overlayPaper(ctx, W, H, paper * strength);

  // 5) ì•½ê°„ì˜ ì›Œì‹œ(ìˆ˜ë¬µ/ìœ í™” ëŠë‚Œ í†¤ ì •ë¦¬)
  overlayWash(ctx, W, H, strength);

  // í‘œì‹œ ì „í™˜
  imgEl.style.display = "none";
  canvas.style.display = "block";

  return canvas.toDataURL("image/png");
}

function loadImageSafe(src){
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

function coverRect(sw, sh, dw, dh){
  const sRatio = sw/sh, dRatio = dw/dh;
  let cw, ch, sx, sy;
  if (sRatio > dRatio){
    ch = sh;
    cw = sh * dRatio;
    sx = (sw - cw)/2; sy = 0;
  } else {
    cw = sw;
    ch = sw / dRatio;
    sx = 0; sy = (sh - ch)/2;
  }
  return { sx, sy, sw: cw, sh: ch };
}

function posterizeAndQuantize(d, palette, strength){
  // palette: 8~32 ê¶Œì¥ (ë‚®ì„ìˆ˜ë¡ ë” ê·¸ë¦¼ ëŠë‚Œ)
  // ê°•ë„ ë†’ì„ìˆ˜ë¡ ë” ê³¼ê°í•˜ê²Œ ë‹¨ìˆœí™”
  const levels = Math.max(6, Math.min(48, Math.round(palette)));
  const step = 255 / (levels - 1);

  // â€œë¶“ í„°ì¹˜â€ ëŠë‚Œ: ì±„ë„ë³„ë¡œ ì•½ê°„ ë‹¤ë¥¸ ì–‘ìí™”
  for(let i=0;i<d.length;i+=4){
    let r = d[i], g = d[i+1], b = d[i+2];

    // ì‚´ì§ í†¤ ì›œ(ìœ í™”/ë™ì–‘í™” ëŠë‚Œ)
    r = r + 12*strength;
    b = b - 8*strength;

    // ì–‘ìí™”(í¬ìŠ¤í„°ë¼ì´ì¦ˆ)
    r = Math.round(r/step)*step;
    g = Math.round(g/step)*step;
    b = Math.round(b/step)*step;

    // ë¯¸ì„¸í•œ ìƒ‰ ë²ˆì§(ê³„ì¡° ë  ëŠë‚Œ ì™„í™”)
    const jitter = (Math.random()*2-1) * (6*strength);
    d[i]   = clamp255(r + jitter);
    d[i+1] = clamp255(g + jitter*0.7);
    d[i+2] = clamp255(b + jitter*0.8);
  }
}

function sobelEdgeMap(imageData, W, H){
  // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜í•œ ë’¤ Sobel
  const src = imageData.data;
  const gray = new Float32Array(W*H);

  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const i = (y*W + x)*4;
      gray[y*W+x] = 0.299*src[i] + 0.587*src[i+1] + 0.114*src[i+2];
    }
  }

  const out = new Float32Array(W*H);
  const gxK = [-1,0,1,-2,0,2,-1,0,1];
  const gyK = [-1,-2,-1,0,0,0,1,2,1];

  for(let y=1;y<H-1;y++){
    for(let x=1;x<W-1;x++){
      let gx = 0, gy = 0, k = 0;
      for(let j=-1;j<=1;j++){
        for(let i=-1;i<=1;i++){
          const v = gray[(y+j)*W + (x+i)];
          gx += v * gxK[k];
          gy += v * gyK[k];
          k++;
        }
      }
      const mag = Math.sqrt(gx*gx + gy*gy);
      out[y*W+x] = mag; // 0~(ëŒ€ëµ 1020)
    }
  }

  // ì •ê·œí™”
  let max = 1;
  for(let i=0;i<out.length;i++) if(out[i] > max) max = out[i];
  for(let i=0;i<out.length;i++) out[i] = out[i] / max; // 0~1

  return out;
}

function overlayEdges(ctx, edges, W, H, amount){
  // amount: 0~1
  if(amount <= 0) return;

  const img = ctx.getImageData(0,0,W,H);
  const d = img.data;

  // ì‰í¬ ë¼ì¸ ìƒ‰(ì§™ì€ ê°ˆìƒ‰)
  const inkR = 45, inkG = 28, inkB = 22;

  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      const e = edges[y*W+x]; // 0~1
      // ì„ê³„ê°’ + ê³¡ì„ 
      const t = smoothStep(0.18, 0.55, e) * amount;

      if(t > 0){
        const i = (y*W + x)*4;
        // ì–´ë‘ìš´ ë¼ì¸ìœ¼ë¡œ ì„ê¸°
        d[i]   = d[i]   * (1 - t) + inkR * t;
        d[i+1] = d[i+1] * (1 - t) + inkG * t;
        d[i+2] = d[i+2] * (1 - t) + inkB * t;
      }
    }
  }
  ctx.putImageData(img,0,0);
}

function overlayPaper(ctx, W, H, amount){
  if(amount <= 0) return;

  // ì¢…ì´ ì§ˆê°: ë°ì€ ì  + ì„¬ìœ  ê²° ë¼ì¸
  const img = ctx.getImageData(0,0,W,H);
  const d = img.data;

  for(let i=0;i<d.length;i+=4){
    const n = (Math.random()*2-1) * 22 * amount; // grain
    d[i]   = clamp255(d[i]   + n);
    d[i+1] = clamp255(d[i+1] + n);
    d[i+2] = clamp255(d[i+2] + n);
  }

  // ì„¬ìœ  ê²°: ê°€ë¡œ ê²° ëŠë‚Œ
  for(let y=0;y<H;y+=3){
    const line = (Math.random()*2-1) * 16 * amount;
    for(let x=0;x<W;x++){
      const i = (y*W + x)*4;
      d[i]   = clamp255(d[i]   + line);
      d[i+1] = clamp255(d[i+1] + line);
      d[i+2] = clamp255(d[i+2] + line);
    }
  }

  ctx.putImageData(img,0,0);

  // ë”°ëœ»í•œ ì¢…ì´í†¤ ì›Œì‹œ
  ctx.save();
  ctx.globalAlpha = 0.20 * amount;
  ctx.fillStyle = "#b79f86";
  ctx.fillRect(0,0,W,H);
  ctx.restore();
}

function overlayWash(ctx, W, H, strength){
  ctx.save();
  ctx.globalAlpha = 0.18 * strength;
  // ìˆ˜ì±„/ìœ í™” ì›Œì‹œ ëŠë‚Œ
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, "rgba(141,110,99,0.55)");
  g.addColorStop(1, "rgba(93,64,55,0.35)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);
  ctx.restore();
}

function smoothStep(edge0, edge1, x){
  const t = clamp01((x - edge0) / (edge1 - edge0));
  return t*t*(3 - 2*t);
}
function clamp01(v){ return Math.max(0, Math.min(1, v)); }
function clamp255(v){ return Math.max(0, Math.min(255, v)); }

  </script>
</body>
</html>
